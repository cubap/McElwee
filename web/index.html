<!DOCTYPE html>
<html>

    <head>
        <title>McElwee Cemetery Exhibit</title>
        <style>
            /* Simplified CSS for web display */

            form[data-hidden] {
                display: none;
            }

            h1,
            h2,
            h3,
            h4,
            h5,
            h6,
            button,
            input {
                color: #a3d1ff;
            }

            button,
            input,
            textarea {
                background: #262626;
                border-color: #666666;
                border-radius: .25em;
                padding: .2em;
                font-size: 1.2rem;
            }

            button[type="submit"] {
                display: block;
                margin: 0 auto;
                padding: .5rem 1.5rem;
            }

            button[type="submit"]::before {
                content: "";
                display: block;
                width: 100%;
            }

            html,
            body {
                background: #060606;
                color: #d6d6d6;
                font-family: sans-serif;
            }

            form {
                border: thin solid #a3d1ff;
                padding: .5rem;
                margin: .5rem 0;
            }

            div#flash-message {
                display: none;
                background-color: #d6d6d6;
                color: #111111;
                padding: .5em;
                font-size: 1.2rem;
            }

            div#flash-message.error {
                display: block;
                background-color: #ff6666;
            }

            div#flash-message.success {
                display: block;
                background-color: #66ff66;
            }
            div#obj-viewer {
                white-space: pre;
                font-family: monospace;
                font-size: .8rem;
                max-height: 12rem;
                overflow: auto;
            }
            div#view {
                background: #d6d6d6;
                padding: 2rem;
                border-top-left-radius: 50%;
                border-top-right-radius: 50%;
                color:#060606;
                margin: 4rem;
                text-align: center;
            }
            div#view h3 {
                text-shadow: 0 -1px 0 rgba(0,0,0,.35);
                color: #f1f1f1;
            }
            .mc-gender{
                float: right;
                font-weight: bold;
            }
            .mc-evidence{
                display: block;
                font-size: 80%;

            }
        </style>
    </head>

    <body>
        <div id="mc-location">
            <h1>McElwee Cemetery</h1>
            <p>
                Some such.
            </p>
        </div>

        <div id="flash-message">
            This &lt;div> should be invisible until a message appears.
        </div>

        <div id="view">
        </div>

         <div id="obj-viewer">
        </div>

        <script src="mcdata.js"></script>
        <script>
            async function get (url) {

                // shortcut
                if(url.length<6){
                    return JSON.parse(localStorage.getItem(url))
                }

                let xhr = new XMLHttpRequest();
                xhr.open("GET", url);
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        let obj, err;
                        if (xhr.status === 200) {
                            try {
                                obj = JSON.parse(xhr.response);
                            } catch (error) {
                                err = error;
                            }
                        } else {
                            err = new Error(xhr.statusText || "GET failed.");
                        }
                        if (typeof callback === "function") {
                            return callback(err, obj);
                        }
                        return obj;
                    }
                };
                xhr.send();
            }

            function expand(obj){
                let toRender = {}
                let findId = obj["@id"]
                let annos = findById(findId)
                // TODO: attach evidence to each property value
                // add each value in a predictable way
                // type properties for possible rendering?
                for(let i=0;i<annos.length;i++){
                    for(let j=0;j<annos[i].body.length;j++){
                        if(annos[i].body[j].evidence) {
                            let evId = (typeof annos[i].body[j].evidence==="object") ? annos[i].body[j].evidence["@id"] : annos[i].body[j].evidence
                            obj.evidence = JSON.parse(localStorage.getItem(evId))
                        } else {
                            obj = Object.assign(annos[i].body[j],obj)
                        }
                    }
                }
                return obj
            }

            function findById(id){
                let everything = Object.keys(localStorage).map(k=>(k&&k.length===4)&&JSON.parse(localStorage.getItem(k)))
                let matches = everything.filter(o=>o.target===id)
                return matches
            }

            function renderEvidence(obj){
                let evidence = document.createElement("a")
                let elink = (typeof obj.evidence==="object") ? obj.evidence["@id"] : obj.evidence
                evidence.setAttribute("href",elink)
                evidence.setAttribute("target","_blank")
                evidence.className = "mc-evidence"
                evidence.textContent = obj.evidence.label || "View evidence"
                return evidence
            }

        function renderPerson(obj, elem) {
            elem.innerHTML = "<h3>" + (obj.label || "unlabeled") + "</h3>"
            elem.append(renderName(obj))
            elem.append(renderGender(obj))
            elem.append(renderProp(obj,"birthDate"))
            elem.append(renderProp(obj,"deathDate"))
            elem.append(renderEvidence(obj))
            document.getElementById("obj-viewer").append(renderObject(obj))
        }
        function renderName(obj) {
            let elem;
            let name = obj.name;
            let joined = obj.givenName + " " + obj.familyName;
            if (name) {
                elem = document.createElement("span")
                elem.textContent = name
                elem.className = "mc-name"
            }
            return elem || null
        }
        function renderProp(obj,prop) {
            let elem;
            if(obj[prop]){
                elem = document.createElement("div")
                elem.textContent = prop + ": " + obj[prop]
                elem.className = "mc-"+prop
            }
            return elem || null
        }
        function renderGender(obj) {
            let elem;
            if (obj.gender) {
                elem = document.createElement("span")
                elem.innerHTML = (obj.gender === "male") ? "&male;" : "&female;"
                elem.className = "mc-gender"
            }	            
            return elem || null
        }
        function renderObject(obj) {
            return document.createElement("span").textContent = JSON.stringify(obj, null, 4)
        }

        function renderLocation(){
            let elem = document.getElementById("mc-location")
            let cemetery = expand(JSON.parse(localStorage.getItem("l001")))
            elem.innerHTML = "<h2>"+cemetery.label+"</h2>"
            let ref = document.createElement("a")
            ref.setAttribute("href",cemetery.seeAlso)
            ref.setAttribute("target","_blank")
            ref.className = "seeAlso"
            ref.textContent = cemetery.seeAlso
            elem.append(ref) 
        }
            
            // load defaulty bits
            renderLocation()
            renderPerson(expand(JSON.parse(localStorage.getItem("p001"))),document.getElementById("view"))
        </script>

    </body>

</html>